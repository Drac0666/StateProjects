import pandas as pd
import os
from datetime import datetime, timedelta

# === ENHANCED FUNCTION: EXPORT MONTHLY ACTIVITY ===
def export_monthly_activity_enhanced(activity_file: str = "activity_log.xlsx", month: str = None):
    if not os.path.exists(activity_file):
        print("Activity log file not found. Run generate_activity() first.")
        return

    df = pd.read_excel(activity_file)
    df["Date"] = pd.to_datetime(df["Date"])
    df["Month"] = df["Date"].dt.to_period("M")

    # Determine the target month
    if month is None:
        target_period = (datetime.today().replace(day=1) - timedelta(days=1)).strftime("%Y-%m")
    else:
        target_period = pd.to_datetime(month).strftime("%Y-%m")

    df = df[df["Month"].astype(str) == target_period]
    if df.empty:
        print(f"No data for {target_period}.")
        return

    df[['SEC_1', 'SEC_2', 'SEC_3', 'Description']] = df['Asset Class'].str.split('_', n=3, expand=True)
    df["Value"] = df["Value"].map("{:,.2f}".format)

    purchases = df[df["Activity"] == "Purchase"]
    paidoffs = df[df["Activity"] == "Paidoff"]

    def clean_output(data):
        return data[["ISIN", "SEC_1", "SEC_2", "SEC_3", "Description", "Value"]].reset_index(drop=True)

    df_purchases = clean_output(purchases)
    df_paidoffs = clean_output(paidoffs)

    with pd.ExcelWriter("MonthlyActivity_Formatted.xlsx", engine="openpyxl") as writer:
        df_purchases.to_excel(writer, sheet_name="Purchases", index=False)
        df_paidoffs.to_excel(writer, sheet_name="Paidoff", index=False)

    print(f"Formatted activity for {target_period} saved to MonthlyActivity_Formatted.xlsx")
