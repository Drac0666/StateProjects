import pandas as pd
import os
from datetime import datetime, timedelta
import glob

# Function to get the previous business day
def previous_business_day():
    today = datetime.today()
    offset = max(1, (today.weekday() + 6) % 7 - 3)  # Ensure it skips weekends
    prev_business_day = today - timedelta(days=offset)
    return prev_business_day

# Get the previous business day date
prev_business_day = previous_business_day()
date_str = prev_business_day.strftime('%d%m%y')

# File pattern to search for
file_pattern = f'ITR_IPDAILY_???_01_{date_str}.csv'

# Folder path where files are stored
folder_path = '/path/to/your/folder/'

# Full path pattern
search_pattern = os.path.join(folder_path, file_pattern)

# Find all files matching the pattern
file_list = glob.glob(search_pattern)

# Initialize an empty DataFrame to aggregate data
all_data = pd.DataFrame()

# Read and aggregate all matching files
for file in file_list:
    df = pd.read_csv(file, sep='~')
    all_data = pd.concat([all_data, df], ignore_index=True)

# Save the aggregated DataFrame to an Excel file
output_filename = f'IP_{date_str}.xlsx'
all_data.to_excel(os.path.join(folder_path, output_filename), index=False)

print(f"Aggregated data saved to {output_filename}")
