import pandas as pd
from scipy.optimize import minimize_scalar

def optimize_row(row, target=0.2):
    """
    Optimizes W for a given row using minimize_scalar to find the value
    where CalculateRW(W, row) is closest to the target, ensuring W > 0.
    
    Parameters:
        row (pd.Series): The row from the DataFrame to use in CalculateRW.
        target (float): The target value for CalculateRW(W).
    
    Returns:
        float: The optimal W for the given row, or None if optimization fails.
    """
    def CalculateRW(W, row):
        # Replace this with your actual row-specific function
        return 0.2 + 0.01 * W + row.get('adjustment', 0)

    def objective(W):
        if W < 0:
            return float('inf')  # Penalize negative W
        return abs(CalculateRW(W, row) - target)

    # Perform the optimization
    result = minimize_scalar(objective, method='Brent')  # Brent handles unconstrained optimization well

    # Return the optimal W if the optimization succeeded
    return result.x if result.success and result.x > 0 else None

# Example DataFrame
data = {
    'id': [1, 2, 3],
    'adjustment': [0.0, 0.005, -0.002]  # Example adjustments for each row
}
df = pd.DataFrame(data)

# Apply the optimization row-wise
df['optimal_W'] = df.apply(lambda row: optimize_row(row), axis=1)

print(df)
