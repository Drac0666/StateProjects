import geopandas as gpd
import pandas as pd
import matplotlib.pyplot as plt

# Load the shapefile (replace 'NUTS_shapefile.shp' with your actual file)
shapefile_path = "NUTS_shapefile.shp"
nuts_gdf = gpd.read_file(shapefile_path)

# Sample dataset with NUTS codes, DQ data, and Occupancy
data = {
    'NUTS': ['NUTS1', 'NUTS2', 'NUTS3', 'NUTS2', 'NUTS1', 'NUTS3', 'NUTS1'],
    'DQ': [1, 0, 1, 1, 0, 0, 1],
    'Occupancy': ['BTL', 'Owner Occupied', 'BTL', 'Owner Occupied', 'BTL', 'Owner Occupied', 'Owner Occupied'],
    'Current Balance': [100000, 150000, 50000, 200000, 300000, 100000, 250000]
}
df = pd.DataFrame(data)

# Aggregate DQ = 1 data by NUTS codes and Occupancy
dq_data = df[df['DQ'] == 1].groupby(['NUTS', 'Occupancy'])['Current Balance'].sum().reset_index()

# Merge the aggregated data with the shapefile GeoDataFrame
merged_gdf = nuts_gdf.merge(dq_data, left_on='NUTS_CODE', right_on='NUTS', how='left')

# Create subplots for each Occupancy status
fig, axes = plt.subplots(1, 2, figsize=(24, 12))  # Two subplots side by side

occupancies = ['BTL', 'Owner Occupied']
for i, occupancy in enumerate(occupancies):
    ax = axes[i]
    occupancy_gdf = merged_gdf[merged_gdf['Occupancy'] == occupancy]
    occupancy_gdf.plot(
        column='Current Balance',  # Visualize Current Balance
        cmap='Reds',               # Color scheme
        legend=True,
        ax=ax,
        missing_kwds={"color": "lightgrey", "label": "No data"}
    )
    ax.set_title(f"Percentage of DQ = 1 for {occupancy}", fontsize=14)
    ax.axis("off")

# Add a main title for the figure
plt.suptitle("DQ = 1 by Occupancy Status (BTL and Owner Occupied)", fontsize=16)

plt.show()
