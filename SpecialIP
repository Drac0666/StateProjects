Add this helper above write_section_table:

def resolve_number_format(fmt: str, col_name: str) -> str:
    """
    Returns Excel number format string based on requested format mode.
    """
    fmt = (fmt or "").lower()
    col = str(col_name).lower()

    # Percent columns always percent
    if "util" in col or "%" in col:
        return "0.0%"

    if fmt == "bn":
        return '0.00" bn"'
    if fmt == "mn":
        return '0.00" mn"'
    if fmt == "accounting":
        return '#,##0'
    if fmt == "auto":
        # fallback to your previous behavior
        if "exposure" in col or "limit" in col:
            return '$#,##0,,"bn"'
        return '#,##0'

    # default safe fallback
    return '#,##0'

def write_section_table(
    title: str,
    table_df: pd.DataFrame,
    start_at_row: int,
    number_format: str = "auto",   # "bn" | "mn" | "accounting" | "auto"
) -> int:

def write_section_table(
    title: str,
    table_df: pd.DataFrame,
    start_at_row: int,
    number_format: str = "auto",   # "bn" | "mn" | "accounting" | "auto"
) -> int:
    if table_df is None or len(table_df) == 0:
        return start_at_row - 1

    tdf = table_df.copy()

    # Section title
    ws.merge_cells(start_row=start_at_row, start_column=1, end_row=start_at_row, end_column=5)
    tcell = ws.cell(start_at_row, 1, title)
    tcell.font = section_font
    tcell.alignment = Alignment(horizontal="left", vertical="center")
    ws.row_dimensions[start_at_row].height = 18

    # Header row
    hdr_row = start_at_row + 1
    cols = list(tdf.columns)

    for j, col_name in enumerate(cols, start=1):
        c = ws.cell(hdr_row, j, str(col_name))
        c.font = header_font
        c.fill = fill_header
        c.alignment = Alignment(horizontal="left" if j == 1 else "right", vertical="center")
    ws.row_dimensions[hdr_row].height = 18

    # Body
    r = hdr_row + 1
    for _, rr in tdf.iterrows():
        for j, col_name in enumerate(cols, start=1):
            v = rr[col_name]
            cell = ws.cell(r, j, v)
            cell.font = body_font
            cell.fill = fill_white
            cell.border = border_bottom
            cell.alignment = Alignment(horizontal="left" if j == 1 else "right", vertical="center")

            if isinstance(v, (int, float, np.integer, np.floating)) and j != 1:
                cell.number_format = resolve_number_format(number_format, col_name)

        ws.row_dimensions[r].height = 16
        r += 1

    # Spacer
    note_row = r
    ws.merge_cells(start_row=note_row, start_column=1, end_row=note_row, end_column=5)
    ncell = ws.cell(note_row, 1, "")
    ncell.font = small_grey
    ncell.alignment = Alignment(horizontal="left", vertical="center")
    ws.row_dimensions[note_row].height = 6

    return note_row

export_limit_onepager_excel(
    report=limits_report,
    subasset_summary=subasset_summary,
    mt_summary=mt_summary,
    output_path="limit_onepager.xlsx"
)

# Inside the function:
current_row = write_section_table(
    "SubAsset Summary",
    subasset_summary,
    current_row,
    number_format="mn"        # ðŸ‘ˆ show millions
)

current_row = write_section_table(
    "Master Trust Summary",
    mt_summary,
    current_row,
    number_format="accounting"  # ðŸ‘ˆ full accounting
